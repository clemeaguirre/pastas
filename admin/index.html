<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Foodtruck Mamma Ia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      updateDoc,
      deleteDoc,
      doc,
      query,
      where,
      orderBy,
      Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
  apiKey: "AIzaSyBbHm2PnBGChH_1b3cDIkWRDFRX0uuKlHQ",
  authDomain: "pastas-da599.firebaseapp.com",
  projectId: "pastas-da599",
  storageBucket: "pastas-da599.firebasestorage.app",
  messagingSenderId: "873860893269",
  appId: "1:873860893269:web:0ba848422e2068c076e2dc"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const pedidoForm = document.getElementById("pedidoForm");
    const pedidosDiv = document.getElementById("pedidosDiv");
    const stockDiv = document.getElementById("stockDiv");
    const fechaFiltro = document.getElementById("fechaFiltro");
    const totalPedidoEl = document.getElementById("totalPedido");
    let platos = [];

    function renderPlatos() {
      const lista = document.getElementById("listaPlatos");
      lista.innerHTML = platos.map((p, i) =>
        `<li>${i + 1}. ${p.pasta} (${p.tipo}) con ${p.salsa} - ${p.extra}</li>`
      ).join('');
    }

    async function guardarPedido() {
      const precioPlato = parseInt(document.getElementById("precioPlato").value || 0);
      const productoExtra = document.getElementById("extraProducto").value;
      const precioExtra = parseInt(document.getElementById("precioExtra").value || 0);
      const total = (platos.length * precioPlato) + precioExtra;

      const fecha = new Date();
      const dia = fecha.toISOString().split("T")[0];

      const pedido = {
        platos,
        timestamp: Timestamp.fromDate(fecha),
        total,
        productoExtra,
        precioExtra,
        estado: "Pendiente",
        dia,
      };

      await addDoc(collection(db, "pedidos"), pedido);
      platos = [];
      renderPlatos();
      calcularTotal();
      cargarPedidos();
    }

    function calcularTotal() {
      const precioPlato = parseInt(document.getElementById("precioPlato").value || 0);
      const precioExtra = parseInt(document.getElementById("precioExtra").value || 0);
      const total = (platos.length * precioPlato) + precioExtra;
      totalPedidoEl.innerText = "Total: $" + total.toLocaleString("es-CL");
    }

    document.getElementById("agregarPlato").onclick = () => {
      const pasta = pedidoForm.pasta.value;
      const tipo = pedidoForm.tipo.value;
      const salsa = pedidoForm.salsa.value;
      const extra = pedidoForm.extra.value;
      platos.push({ pasta, tipo, salsa, extra });
      renderPlatos();
      calcularTotal();
    };

    pedidoForm.onsubmit = async (e) => {
      e.preventDefault();
      if (platos.length === 0) return alert("Agrega al menos un plato");
      await guardarPedido();
    };

    async function cargarPedidos(diaSeleccionado = null) {
      pedidosDiv.innerHTML = "";
      const q = diaSeleccionado
        ? query(collection(db, "pedidos"), where("dia", "==", diaSeleccionado), orderBy("timestamp", "asc"))
        : query(collection(db, "pedidos"), orderBy("timestamp", "desc"));

      const snapshot = await getDocs(q);
      let contador = 0;
      snapshot.forEach((docSnap) => {
        const p = docSnap.data();
        contador++;
        pedidosDiv.innerHTML += `
          <div class="bg-white p-4 shadow rounded mb-4">
            <h3 class="font-bold">Pedido ${contador} - ${p.estado}</h3>
            <p class="text-sm text-gray-500">${new Date(p.timestamp.toDate()).toLocaleString()}</p>
            <ul class="list-disc pl-5">
              ${p.platos.map(plato => `<li>${plato.pasta} ${plato.tipo} con ${plato.salsa} - ${plato.extra}</li>`).join('')}
            </ul>
            ${p.productoExtra ? `<p><strong>Extra:</strong> ${p.productoExtra} - $${p.precioExtra}</p>` : ""}
            <p><strong>Total:</strong> $${p.total}</p>
            <select onchange="cambiarEstado('${docSnap.id}', this.value)" class="border p-1 mt-2">
              <option ${p.estado === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
              <option ${p.estado === 'Listo' ? 'selected' : ''}>Listo</option>
              <option ${p.estado === 'Entregado' ? 'selected' : ''}>Entregado</option>
            </select>
            <button onclick="borrarPedido('${docSnap.id}')" class="ml-2 bg-red-500 text-white px-2 py-1 rounded">Eliminar</button>
          </div>
        `;
      });
    }

    window.borrarPedido = async function (id) {
      if (confirm("¿Estás seguro de eliminar este pedido?")) {
        await deleteDoc(doc(db, "pedidos", id));
        cargarPedidos();
      }
    }

    window.cambiarEstado = async function (id, nuevoEstado) {
      await updateDoc(doc(db, "pedidos", id), {
        estado: nuevoEstado
      });
    }

    fechaFiltro.onchange = () => {
      const fecha = fechaFiltro.value;
      if (fecha) cargarPedidos(fecha);
      else cargarPedidos();
    };

    document.getElementById("precioPlato").addEventListener("input", calcularTotal);
    document.getElementById("precioExtra").addEventListener("input", calcularTotal);

    async function cargarStock() {
      stockDiv.innerHTML = "<h2 class='text-xl font-bold mt-6 mb-2'>Editar Stock</h2>";
      const snapshot = await getDocs(collection(db, "stock"));
      snapshot.forEach((docSnap) => {
        const d = docSnap.data();
        const row = document.createElement("div");
        row.className = "flex gap-2 items-center mb-2";
        row.innerHTML = `
          <span class='w-32'>${d.pasta} - ${d.tipo}</span>
          <input type='number' id='stock-${docSnap.id}' value='${d.cantidad}' class='border p-1 w-20' />
          <button class='bg-blue-500 text-white px-2 py-1 rounded' onclick="actualizarStock('${docSnap.id}')">Guardar</button>
        `;
        stockDiv.appendChild(row);
      });
    }

    window.actualizarStock = async function (id) {
      const input = document.getElementById("stock-" + id);
      const nuevaCantidad = parseInt(input.value);
      await updateDoc(doc(db, "stock", id), {
        cantidad: nuevaCantidad
      });
      alert("Stock actualizado correctamente");
    }

    cargarPedidos();
    cargarStock();
  </script>
</head>
<body class="bg-gray-100 p-4">
  <h1 class="text-2xl font-bold mb-4">Admin - Foodtruck Mamma Ia</h1>
  <form id="pedidoForm" class="bg-white p-4 rounded shadow mb-4">
    <input id="precioPlato" type="number" value="6000" placeholder="Precio por plato" class="border p-2 w-full mb-2" />
    <input id="extraProducto" type="text" placeholder="Producto extra (ej: agua)" class="border p-2 w-full mb-2" />
    <input id="precioExtra" type="number" placeholder="Precio extra (ej: 1000)" class="border p-2 w-full mb-2" />
    <div id="totalPedido" class="text-right font-bold text-lg mb-2">Total: $0</div>
    <select name="pasta" class="border p-2 w-full mb-2">
      <option>spaguetti</option>
      <option>fettuccine</option>
      <option>pappardelle</option>
    </select>
    <select name="tipo" class="border p-2 w-full mb-2">
      <option>huevo</option>
      <option>espinaca</option>
      <option>betarraga</option>
    </select>
    <select name="salsa" class="border p-2 w-full mb-2">
      <option>pomodoro</option>
      <option>alfredo champiñón</option>
      <option>alfredo tocino</option>
      <option>alfredo queso azul y parmesano</option>
      <option>all'amatriciana</option>
      <option>bolognesa</option>
      <option>bolognesa rosa</option>
      <option>all'arrabiata</option>
      <option>all'vodka</option>
    </select>
    <input type="text" name="extra" class="border p-2 w-full mb-2" placeholder="Comentario (ej: sin queso)" />
    <button type="button" id="agregarPlato" class="bg-green-600 text-white px-4 py-2 rounded mb-2">Agregar Plato</button>
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Guardar Pedido</button>
  </form>
  <ul id="listaPlatos" class="mb-4 list-disc pl-5"></ul>

  <div class="bg-white p-4 rounded shadow mb-4">
    <h2 class="text-xl font-bold mb-2">Pedidos por fecha</h2>
    <input type="date" id="fechaFiltro" class="border p-2" />
  </div>

  <div id="pedidosDiv" class="mb-6"></div>

  <div id="stockDiv"></div>
</body>
</html>
